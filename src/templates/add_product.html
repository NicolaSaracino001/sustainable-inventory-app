{% extends "base.html" %}

{% block title %}Nuovo Prodotto - S.I.M.{% endblock %}

{% block content %}
    
    <div class="form-container" style="max-width: 600px;"> <h2>Aggiungi Nuovo Prodotto</h2>
        
        <form action="" method="POST">
            
            <div class="form-group">
                <label for="barcode">Codice a Barre (Barcode):</label>
                <input type="text" id="barcode" name="product_barcode" class="form-control" placeholder="Scansiona o digita..." autofocus>
            </div>

            <div class="form-group">
                <label for="name">Nome Prodotto:</label>
                <input type="text" id="name" name="product_name" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="category">Categoria:</label>
                <select id="category" name="product_category" class="form-control">
                    <option value="general">Generale / Altro</option>
                    <option value="meat">Carne e Pesce</option>
                    <option value="dairy">Latticini e Uova</option>
                    <option value="fruit_veg">Frutta e Verdura</option>
                    <option value="bakery">Pane e Prodotti da Forno</option>
                    <option value="dry">Secco (Pasta, Riso, Scatolame)</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label for="quantity">Quantità:</label>
                    <input type="number" id="quantity" name="product_quantity" class="form-control" step="0.01" required>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label for="cost">Costo per Unità (€):</label>
                    <input type="number" id="cost" name="product_cost" class="form-control" step="0.01">
                </div>
            </div>
            
            <div class="form-group">
                <label for="expiry">Data di Scadenza:</label>
                <input type="date" id="expiry" name="product_expiry" class="form-control" required>
            </div>
            
            <div class="form-group" style="text-align: center; margin-top: 20px;">
                <button type="submit" class="btn-submit" style="width: 100%;">Salva Prodotto</button>
            </div>

        </form>
    </div>


    <script>
        const barcodeInput = document.getElementById('barcode');
        const nameInput = document.getElementById('name');
        const categoryInput = document.getElementById('category');
        const costInput = document.getElementById('cost');

    // Ascoltiamo quando l'utente finisce di scrivere/scansionare il barcode
        barcodeInput.addEventListener('change', function() {
            const code = barcodeInput.value;

            if (code) {
                // Chiamiamo la nostra API Python
                fetch('/api/get_product_info/' + code)
                    .then(response => response.json())
                    .then(data => {
                        if (data.found) {
                            // Se il prodotto esiste, compiliamo i campi!
                            nameInput.value = data.name;
                            categoryInput.value = data.category;

                            // Compiliamo il costo solo se è vuoto (per non sovrascrivere se l'utente lo stava cambiando)
                            if (!costInput.value && data.cost) {
                            costInput.value = data.cost;
                            }

                            // Feedback visivo (lampeggio verde)
                            nameInput.style.backgroundColor = "#e8f5e9";
                            setTimeout(() => nameInput.style.backgroundColor = "", 1000);
                        }
                    })
                    .catch(error => console.error('Errore:', error));
            }
        });
    </script>

{% endblock %}