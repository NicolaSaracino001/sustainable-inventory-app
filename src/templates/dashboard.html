{% extends "base.html" %}

{% block title %}Dashboard - S.I.M.{% endblock %}

{% block content %}
    <h2>Dashboard Prodotti</h2>

<div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 25px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; border-left: 5px solid #004d40;">
        
        <div style="flex: 1; min-width: 250px; margin-right: 20px;">
            <h3 style="margin: 0 0 10px 0; color: #333;">üéØ Obiettivo Spreco Settimanale</h3>
            <p style="margin: 0; color: #666; font-size: 0.95rem;">
                Spreco attuale: <strong>‚Ç¨ {{ "%.2f"|format(weekly_waste_cost) }}</strong> / Budget Max: ‚Ç¨ {{ "%.2f"|format(weekly_budget) }}
            </p>
            
            <div style="background-color: #e0e0e0; border-radius: 10px; height: 20px; width: 100%; margin-top: 10px; overflow: hidden;">
                <div style="height: 100%; width: {{ waste_percentage }}%; 
                            background-color: {{ '#dc3545' if weekly_waste_cost > weekly_budget else '#28a745' }}; 
                            transition: width 0.5s ease-in-out;">
                </div>
            </div>
        </div>

        <div style="text-align: center; min-width: 100px;">
            {% if weekly_waste_cost <= weekly_budget %}
                <div style="font-size: 3.5rem;">üèÖ</div>
                <div style="color: #28a745; font-weight: bold;">Eco-Hero!</div>
            {% else %}
                <div style="font-size: 3.5rem;">üí∏</div>
                <div style="color: #dc3545; font-weight: bold;">Budget Superato</div>
            {% endif %}
        </div>

</div>
  
<div class="cards-container">

    <div class="kpi-card card-blue">
        <div class="card-icon"><i class="fas fa-boxes"></i></div>
        <div class="card-info">
            <h3>Totale Prodotti</h3>
            <p>{{ total_products }}</p>
        </div>
    </div>

    <div class="kpi-card card-green">
        <div class="card-icon"><i class="fas fa-euro-sign"></i></div>
        <div class="card-info">
            <h3>Valore Magazzino</h3>
            <p>‚Ç¨ {{ "%.2f"|format(total_value) }}</p>
        </div>
    </div>

    <div class="kpi-card card-red">
        <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="card-info">
            <h3>In Scadenza (7gg)</h3>
            <p>{{ expiring_soon }}</p>
        </div>
    </div>

</div>

    <div style="margin-bottom: 20px; background-color: #f1f1f1; padding: 15px; border-radius: 5px;">
    <form action="{{ url_for('inventory_bp.dashboard') }}" method="GET" style="display: flex; gap: 10px;">
        <input type="text" name="search" class="form-control" placeholder="Spara col Barcode o Cerca per Nome..." autofocus style="flex: 1;">

        <button type="submit" class="btn-submit"><i class="fas fa-search"></i> Cerca</button>

        <a href="{{ url_for('inventory_bp.dashboard') }}" style="padding: 10px; text-decoration: none; color: #333; border: 1px solid #ccc; border-radius: 4px; background: white;">Mostra Tutti</a>
        <a href="{{ url_for('inventory_bp.export_inventory') }}" style="padding: 10px; text-decoration: none; color: white; background-color: #198754; border-radius: 4px; font-weight: bold;">
            <i class="fas fa-file-excel"></i> Export Excel
        </a>
    </form>
</div>


    <table border="1" width="100%">
        <thead>
            <tr>
                <th>Barcode</th>
                <th>Nome Prodotto</th>
                <th>Quantit√†</th>
                <th>Stato Scorte</th> <th>Costo/Unit√†</th>
                <th>Data Scadenza</th>
                <th style="text-align: center;">Tip</th>
                <th>Azione</th>
                <th>Usa / Spreca (Aggiorna Quantit√†)</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            
            {% set days_left = (product.expiry_date.date() - today).days %}
            
            {% if days_left < 0 %}
                <tr class="tr-expired">
            {% elif days_left <= 7 %}
                <tr class="tr-danger">
            {% elif days_left <= 30 %}
                <tr class="tr-warning">
            {% else %}
                <tr>
            {% endif %}
            
                <td><strong>{{ product.barcode if product.barcode else '-' }}</strong></td>
                <td>{{ product.name }}</td>
                <td>{{ product.quantity }}</td>

                <td style="text-align: center;">
                    {% if product.quantity <= 5 %}
                        <a href="mailto:?subject=Ordine Urgente: {{ product.name }}&body=Salve,%0D%0A%0D%0AVorrei effettuare un riordino per il seguente prodotto:%0D%0A%0D%0A- Prodotto: {{ product.name }}%0D%0A- Codice: {{ product.barcode }}%0D%0A- Scorta residua: {{ product.quantity }}%0D%0A%0D%0AGrazie."
                           style="background-color: #ff9800; color: white; padding: 5px 8px; border-radius: 4px; text-decoration: none; font-weight: bold; font-size: 0.85rem; display: inline-block;">
                           <i class="fas fa-envelope"></i> Ordina
                        </a>
                    {% else %}
                        <span style="color: #28a745; font-weight: bold; font-size: 0.9rem;">
                            OK <i class="fas fa-check-circle"></i>
                        </span>
                    {% endif %}
                </td>
                <td>‚Ç¨ {{ "%.2f"|format(product.cost_per_unit) if product.cost_per_unit else 'N/A' }}</td>
                <td>{{ product.expiry_date.strftime('%Y-%m-%d') }}</td>
                
                <td style="text-align: center;">
                    {% if days_left <= 7 %}
                        <button 
                            onclick="alert('{{ tips.get(product.category, tips['general']) }}')"
                            style="background: none; border: none; cursor: pointer; font-size: 1.5rem;"
                            title="Clicca per un consiglio anti-spreco!">
                            üí°
                        </button>
                    {% else %}
                        <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>
                
                <td>
                    <a href="{{ url_for('inventory_bp.delete_product', product_id=product.id) }}" 
                       onclick="return confirm('Sei sicuro di voler eliminare questo prodotto?');"
                       style="color: #dc3545; text-decoration: none; font-size: 1.2rem;"
                       title="Elimina Prodotto">
                       <i class="fas fa-trash-alt"></i>
                    </a>
                </td>

                <td>
                    <form action="{{ url_for('inventory_bp.update_stock', product_id=product.id) }}" method="POST" style="display: flex; align-items: center;">
                        <input type="number" name="quantity_to_update" step="0.01" min="0" 
                               placeholder="Q.t√†" style="width: 60px; margin-right: 5px;" required>
                        <button type="submit" name="action" value="use" title="Usa"><i class="fas fa-check"></i></button>
                        <button type="submit" name="action" value="waste" title="Spreca"><i class="fas fa-trash"></i></button>
                    </form>
                </td>
            
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if not products %}
        <p>Nessun prodotto nell'inventario. Aggiungine uno!</p>
    {% endif %}

{% endblock %}