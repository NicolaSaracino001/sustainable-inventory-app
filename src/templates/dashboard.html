{% extends "base.html" %}

{% block title %}Dashboard - S.I.M.{% endblock %}

{% block content %}
    <h2>Dashboard Prodotti</h2>
    <div style="margin-bottom: 20px; background-color: #f1f1f1; padding: 15px; border-radius: 5px;">
    <form action="{{ url_for('inventory_bp.dashboard') }}" method="GET" style="display: flex; gap: 10px;">
        <input type="text" name="search" class="form-control" placeholder="Spara col Barcode o Cerca per Nome..." autofocus style="flex: 1;">

        <button type="submit" class="btn-submit">Cerca</button>

        <a href="{{ url_for('inventory_bp.dashboard') }}" style="padding: 10px; text-decoration: none; color: #333; border: 1px solid #ccc; border-radius: 4px; background: white;">Mostra Tutti</a>
    </form>
</div>


    <table border="1" width="100%">
        <thead>
            <tr>
                <th>Barcode</th>
                <th>Nome Prodotto</th>
                <th>Quantità</th>
                <th>Costo/Unità</th>
                <th>Data Scadenza</th>
                <th>Azione</th> 
                <th>Usa / Spreca (Aggiorna Quantità)</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}

            {% set days_left = (product.expiry_date.date() - today).days %}

            {% if days_left < 0 %}
                <tr class="tr-expired">
            {% elif days_left <= 7 %}
                <tr class="tr-danger">
            {% elif days_left <= 30 %}
                <tr class="tr-warning">
            {% else %}
                <tr>
            {% endif %}

                <td><strong>{{ product.barcode if product.barcode else '-' }}</strong></td>

                <td>{{ product.name }}</td>
                <td>{{ product.quantity }}</td>
                <td>€ {{ "%.2f"|format(product.cost_per_unit) if product.cost_per_unit else 'N/A' }}</td>
                <td>{{ product.expiry_date.strftime('%Y-%m-%d') }}</td>

                <td>
                    <a href="{{ url_for('inventory_bp.delete_product', product_id=product.id) }}" 
                       onclick="return confirm('Sei sicuro di voler eliminare questo prodotto?');">
                       Elimina
                    </a>
                </td>

                <td>
                    <form action="{{ url_for('inventory_bp.update_stock', product_id=product.id) }}" method="POST" style="display: flex; align-items: center;">

                        <input type="number" name="quantity_to_update" step="0.01" min="0" 
                               placeholder="Q.tà" style="width: 60px; margin-right: 5px;" required>

                        <button type="submit" name="action" value="use">Usa</button>
                        <button type="submit" name="action" value="waste">Spreca</button>

                    </form>
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if not products %}
        <p>Nessun prodotto nell'inventario. Aggiungine uno!</p>
    {% endif %}

{% endblock %}